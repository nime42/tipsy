<!DOCTYPE html>
<html lang="se">

<head>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link href="css/login.css" rel="stylesheet">
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.js"></script>
    <script src="/handlebars/myHbsFunctions.js"></script>
    <script src="/handlebars/login-register-snippets.hbs" type="text/x-handlebars-templates"></script>
    <script src="/js/utils.js"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script>
        $(function () {

            precompileHbs();


            $('#login-form-link').click(function (e) {
                $("#error-message").hide();
                $("#login-form").delay(100).fadeIn(100);
                $("#register-form").fadeOut(100);
                $('#register-form-link').removeClass('active');
                $(this).addClass('active');
                e.preventDefault();
            });
            $('#register-form-link').click(function (e) {
                $("#error-message").hide();
                $("#register-form").delay(100).fadeIn(100);
                $("#login-form").fadeOut(100);
                $('#login-form-link').removeClass('active');
                $(this).addClass('active');
                e.preventDefault();
            });


    

            if(getUrlVars()["reset-token"]) {
                $("#error-message").hide();
                $('#login-form-link').hide();
                $("#login-form").hide();
                $('#register-form-link').hide();
                $("#register-form").hide();
                $("#reset-password-form-link").addClass('active');
                $("#reset-password-form-link").show();
                $("#reset-password-form").show();
            }


            $('#forgot-password').click(function (e) {
                data={};
                hbsModal("#basicModal",hbsTemplates["login-register-snippets"]["forgot-password"],data);
                e.preventDefault();

                $("#basicModal").find(".forgot-password").click(function(e) {
                    var buttonId = $(this).attr('id');
                    var identityType;
                    var identity;
                    if(buttonId==="send-mail-for-mail-adr") {
                        identityType="by-mail-adress";
                        identity=$("#basicModal").find("#email").val().trim();
                        if(identity==="" || !identity.match(/^[^@]+@[^@]+\.[^@]+$/)) {
                           $("#basicModal").find("#error-message").text("Mailadress saknas eller verkar vara ogiltig!!").show();
                           return;
                        }
                    } else if(buttonId==="send-mail-for-userid") {
                        identityType="by-user-id";
                        identity=$("#basicModal").find("#userid").val().trim();
                        if(identity==="") {
                            $("#basicModal").find("#error-message").text("Användarnamn saknas!!").show();
                           return;
                        }
                    } else {
                        $("#basicModal").find("#error-message").text("Ett tekniskt fel har inträffat!").show();
                           return;

                    }

                    $.ajax({
                        type: "POST",
                        url: "/forgotPassword",
                        data: {
                            identityType: identityType,
                            identity: identity
                        },
                        success: function (data, status, jqxhr) {
                            hbsModal("#basicModal",hbsTemplates["login-register-snippets"]["reset-mail-sent"],{});
                        },
                        error:function(data, status, jqxhr) {
                            if(data.status===404) {
                                if(identityType==="by-mail-adress") {
                                    $("#basicModal").find("#error-message").text("Det finns ingen användare med denna mail-adress!!").show();
                                } else {
                                    $("#basicModal").find("#error-message").text("Det finns ingen användare med detta användarnamn!!").show();

                                }
                            } else {
                                $("#basicModal").find("#error-message").text("Det gick inte att skicka återställnings-mailet!!").show();
                            }
                        }
                    });




                });

            });

            $("#confirm-password").keyup(function(e) {
                var pwd1=$("#register-password").val().trim();
                var pwd2=$("#confirm-password").val().trim();
                if(!pwd1.startsWith(pwd2)) {
                    $("#error-message").text("Lösenorden stämmer inte överens!!").show();
                } else {
                    $("#error-message").hide();
                }
            })

            $("#confirm-reset-password").keyup(function(e) {
                var pwd1=$("#reset-password").val().trim();
                var pwd2=$("#confirm-reset-password").val().trim();
                if(!pwd1.startsWith(pwd2)) {
                    $("#error-message").text("Lösenorden stämmer inte överens!!").show();
                } else {
                    $("#error-message").hide();
                }
            })



            $("#login-submit").click(function (e) {
                $("#error-message").hide();
                var username = $("#login-username").val().trim();
                var password = $("#login-password").val().trim();
                if (username === "" || password === "") {
                    $("#error-message").text("Användarnamn eller lösenord saknas!!!").show();
                } else {
                    $.ajax({
                        type: "POST",
                        url: "/login",
                        data: {
                            username: username,
                            password: password
                        },
                        success: function (data, status, jqxhr) {
                            var inviteToken= getUrlVars()["invite-token"];
                            if(inviteToken) {
                                addUserToGroup(inviteToken,
                                function(groupName) {
                                    window.location.href = "/main.html?new-group="+groupName;
                                },
                                function(err) {
                                    window.location.href = "/main.html";
                                }
                                );
                            } else {
                                window.location.href = "/main.html";
                            }
                        },
                        error:function(data, status, jqxhr) {
                            if(data.status===401) {
                                $("#error-message").text("Ogiltigt användarnamn eller lösenord!!!").show();
                            } else {
                                $("#error-message").text("Just nu går det inte att logga in, försök senare!").show();

                            }
                        }
                    });
                }
            })

            $("#register-submit").click(function (e) {
                $("#error-message").hide();
                var username = $("#register-username").val().trim();
                var password=$("#register-password").val().trim();
                var pwd2=$("#confirm-password").val().trim();
                var email=$("#email").val().trim();

                
                if (username === "") {
                    $("#error-message").text("Användarnamn saknas!!!").show();
                    return;
                }
                if (password === "") {
                    $("#error-message").text("Lösenord saknas!!!").show();
                    return;
                } 
 
                if(password!==pwd2) {
                    $("#error-message").text("Lösenorden stämmer inte överens!!").show();
                    return;
                }
                if(email==="" || !email.match(/^[^@]+@[^@]+\.[^@]+$/)) {
                    $("#error-message").text("Mailadress saknas eller verkar vara ogiltig!!").show();
                    return;
                }

                $.ajax({
                        type: "POST",
                        url: "/register",
                        data: {
                            username: username,
                            password: password,
                            email:email
                        },
                        success: function (data, status, jqxhr) {
                            var inviteToken= getUrlVars()["invite-token"];
                            if(inviteToken) {
                                addUserToGroup(inviteToken,
                                function(groupName) {
                                    window.location.href = "/main.html?new-group="+groupName;
                                },
                                function(err) {
                                    window.location.href = "/main.html";
                                }
                                );
                            } else {
                                window.location.href = "/main.html";
                            }
                        },
                        error:function(data, status, jqxhr) {
                            if(data.status===403) {
                                $("#error-message").text("Användarnamnet finns redan!").show();
                            } else {
                                $("#error-message").text("Ett Tekniskt fel har inträffat, försök igen senare!").show();
                            }
                        }
                    });
            })



            $("#reset-submit").click(function (e) {

                $("#error-message").hide();
                var password=$("#reset-password").val().trim();
                var pwd2=$("#confirm-reset-password").val().trim();

                if (password === "") {
                    $("#error-message").text("Lösenord saknas!!!").show();
                    return;
                } 


                if(password!==pwd2) {
                    $("#error-message").text("Lösenorden stämmer inte överens!!").show();
                    return;
                }

                var resetToken=getUrlVars()["reset-token"];
                $.ajax({
                        type: "POST",
                        url: "/resetPassword",
                        data: {
                            password: password,
                            resetToken:resetToken
                        },
                        success: function (data, status, jqxhr) {
                            window.location.href = "/main.html";
                        },
                        error:function(data, status, jqxhr) {
                            if(data.status===404) {
                                $("#error-message").text("Det gick inte att uppdatera lösenordet").show();
                            } else {
                                $("#error-message").text("Ett Tekniskt fel har inträffat, försök igen senare!").show();
                            }
                        }
                    });
            })





        });


 
        function addUserToGroup(inviteToken,successFun,failureFun) {
            $.ajax({
                        type: "POST",
                        url: "/addInvitedUserToGroup",
                        data: {
                            inviteToken:inviteToken
                        },
                        success: function (data, status, jqxhr) {
                            successFun(data.groupName);
                        },
                        error:function(data, status, jqxhr) {
                            failureFun(data,status,jqxhr);
                        }
                    });

        }


    </script>
    <title>Login</title>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-md-offset-3">
                <div class="panel panel-login">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-xs-4">
                                <a href="#" class="active" id="login-form-link">Login</a>
                            </div>
                            <div class="col-xs-4">
                                <a href="#" id="reset-password-form-link" style="display: none;">Återställ lösenord</a>
                            </div>
                            <div class="col-xs-4">
                                <a href="#" id="register-form-link">Register</a>
                            </div>
                        </div>
                        <hr>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <p id="error-message" class="text-center text-danger" style="display: none;"></p>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <form id="login-form" action="" method="post"
                                    role="form" style="display: block;">
                                    <div class="form-group">
                                        <input type="text" name="username" id="login-username" tabindex="1"
                                            class="form-control" placeholder="Username" value="">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="password" id="login-password" tabindex="2"
                                            class="form-control" placeholder="Password">
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm-6 col-sm-offset-3">
                                                <input type="button" name="login-submit" id="login-submit" tabindex="4"
                                                    class="form-control btn btn-login" value="Log In">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <div class="text-center">
                                                    <a id="forgot-password" href="" tabindex="5"
                                                        class="forgot-password">Glömt lösenord?</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <form id="register-form" action="" method="post"
                                    role="form" style="display: none;">
                                    <div class="form-group">
                                        <input type="text" name="username" id="register-username" tabindex="1"
                                            class="form-control" placeholder="Username" value="">
                                    </div>
                                    <div class="form-group">
                                        <input type="email" name="email" id="email" tabindex="1" class="form-control"
                                            placeholder="Email Address" value="">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="password" id="register-password" tabindex="2"
                                            class="form-control" placeholder="Password">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="confirm-password" id="confirm-password"
                                            tabindex="2" class="form-control" placeholder="Confirm Password">
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm-6 col-sm-offset-3">
                                                <input type="button" name="register-submit" id="register-submit"
                                                    tabindex="4" class="form-control btn btn-register"
                                                    value="Register Now">
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <form id="reset-password-form" action="" method="post"
                                    role="form" style="display: none;">
                                    <div class="form-group">
                                        <input type="password" name="password" id="reset-password" tabindex="2"
                                            class="form-control" placeholder="Nytt lösenord">
                                    </div>
                                    <div class="form-group">
                                        <input type="password" name="confirm-password" id="confirm-reset-password"
                                            tabindex="2" class="form-control" placeholder="Bekräfta lösenord">
                                    </div>
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-sm-6 col-sm-offset-3">
                                                <input type="button" name="login-submit" id="reset-submit" tabindex="4"
                                                    class="form-control btn btn-login" value="Uppdatera">
                                            </div>
                                        </div>
                                    </div>
                                </form>


                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Modal -->
<div class="modal fade" id="basicModal" tabindex="-1" role="dialog" aria-hidden="true"></div>

</body>

</html>